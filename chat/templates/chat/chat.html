{% extends 'chat/base.html' %}

{% block title %}{{room.title}}{%endblock title %}

{% block content %}

<div class="col-sm-6 col-sm-offset-3  frame">
    <ul id="messages">
    {% for msg in messages %}

            {% if msg.author == user%}
            <li style="width:100%">
                <div class="msj macro">
                   <div class="avatar"><!--<img class="img-circle" style="width:100%;" src="'+ me.avatar +'" />--><p><small>{{msg.author.first_name}}</small></p></div>
                        <div class="text text-l">
                                <p>{{msg.text}}</p>
                               <p><small>{{msg.pub_date}}</small></p>
                        </div>

                </div>
            </li>
            {% else %}
            <li style="width:100%">
                <div class="msj-rta macro">

                        <div class="text text-r">
                                <p>{{msg.text}}</p>
                                <p><small>{{msg.pub_date}}</small></p>
                        </div>
                    <div class="avatar"><!--<img class="img-circle" style="width:100%;" src="'+ me.avatar +'" />--><p><small>{{msg.author.first_name}}</small></p></div>
                </div>
            </li>
            {% endif %}

    {% endfor %}
    </ul>
</div>

<div class="form">
    <form class="chatform">
        {{form.as_p}}
        <button id="id_send" type="submit">Send</button>
    </form>
</div>

{% endblock content %}

{% block script%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.4/js.cookie.min.js"></script>
<script>
    var room=window.location.pathname.slice(6).slice(0,-1);
    var socket = new WebSocket('ws://' + window.location.host + '/chat/' + room);
    var owner=false;

    socket.onopen = function open() {
      console.log("connected");
    };

    socket.onmessage = function(e) {
        var date=new Date();
        var data=JSON.parse(e.data)
        console.log(data["msg"])
        if(owner){
            var message=$("<li style='width:100%'><div class='msj macro'><div class='avatar'>              <p><small>" + data['author'] +"</small></p></div><div class='text text-l'><p>" + data['msg'] +"</p> <p><small>"+ date +"</small></p></div></div></li>");
            owner=false;
            }
         else{
            var message=$("<li style='width:100%'><div class='msj-rta macro'><div class='text text-r'><p>" + data['msg'] +"</p> <p><small>"+ date +"</small></p></div><div class='avatar'><p><small>" + data['author'] +"</small></p></div></div></li>");

         }
        $('#messages').append(message);
    }

    if (socket.readyState == WebSocket.OPEN) {
      socket.onopen();
    }

    $("form").submit(function(){
        var m=$("#id_text").val();
        owner=true;
        socket.send(m);
        var csrftoken=Cookies.get('csrftoken');
        $.post(window.location.pathname, {'text':m, 'csrfmiddlewaretoken': csrftoken}, function(result){

        });

        $("#id_text").val("");
        return false;
    })
  </script>
{% endblock script%}